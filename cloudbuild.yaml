substitutions:
  _AWS_PRIVATE_IP: "13.56.249.248"


options:
  logging: CLOUD_LOGGING_ONLY  

steps:
# Step 1: Setup SSH Key
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Setup SSH'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      mkdir -p ~/.ssh
      echo "$$SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
      chmod 600 ~/.ssh/id_rsa
      ssh-keyscan -H "$_AWS_PRIVATE_IP" >> ~/.ssh/known_hosts
  secretEnv: ['SSH_KEY']


- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Debug SSH Key'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "First 3 lines of SSH key:"
      head -3 ~/.ssh/id_rsa
  secretEnv: ['SSH_KEY']


# Step 2: Pre-Requisites (clone repo + set permissions)
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Run Pre-Requisites'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      ssh -o StrictHostKeyChecking=no ubuntu@$_AWS_PRIVATE_IP << 'EOF'
        rm -rf /home/ubuntu/Udemy-section*
        git clone https://github.com/sagarkakkalasworld/Udemy-section9
        cd Udemy-section9
        chmod 744 build.sh
        chmod 744 deploy.sh
      EOF
  secretEnv: ['SSH_KEY']

# Step 3: Build
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Build App'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      ssh -o StrictHostKeyChecking=no ubuntu@$_AWS_PRIVATE_IP "bash /home/ubuntu/Udemy-section9/build.sh"
  secretEnv: ['SSH_KEY']

# Step 4: Deploy
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Deploy App'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      ssh -o StrictHostKeyChecking=no ubuntu@$_AWS_PRIVATE_IP "bash /home/ubuntu/Udemy-section9/deploy.sh"
  secretEnv: ['SSH_KEY']

# Define secret for SSH_KEY
availableSecrets:
  secretManager:
    - versionName: projects/381798847413/secrets/SSH_KEY/versions/latest
      env: 'SSH_KEY'
